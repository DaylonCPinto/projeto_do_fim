{% extends "base.html" %}
{% load wagtailcore_tags wagtailimages_tags navigation_tags %}

{% block title %}{{ page.title }}{% endblock %}

{% block content %}
    <!-- HEADER DO ARTIGO -->
    <article class="modern-article">
        <div class="article-header">
            <h1 class="article-title" style="font-family: '{{ page.title_font }}', sans-serif;">
                {{ page.title }}
                {% if page.is_premium %}
                    <span class="premium-badge">Premium</span>
                {% endif %}
            </h1>
            <div class="article-meta">
                <i class="bi bi-calendar3"></i> Publicado em: {{ page.publication_date|date:"d/m/Y H:i" }}
                <span class="mx-2">•</span>
                <i class="bi bi-clock"></i> há {{ page.publication_date|timesince_brasilia }}
                {% if page.last_published_at and page.first_published_at and page.last_published_at != page.first_published_at %}
                    <span class="mx-2">•</span>
                    <i class="bi bi-pencil"></i> <span class="text-muted">editado há {{ page.last_published_at|timesince_brasilia }}</span>
                {% endif %}
            </div>
        </div>

        <!-- IMAGEM DE DESTAQUE -->
        {% if page.featured_image or page.external_image_url %}
        <div class="featured-image-container mb-4">
            {% if page.external_image_url %}
                <img src="{{ page.external_image_url }}" alt="{{ page.title }}" class="img-fluid rounded">
            {% elif page.featured_image %}
                {% image page.featured_image original class="img-fluid rounded" %}
            {% endif %}
        </div>
        {% endif %}

        <!-- INTRODUÇÃO - SEMPRE VISÍVEL -->
        <div class="article-introduction lead mb-4">
            {{ page.introduction|richtext }}
        </div>

        <hr class="article-divider my-4">

        <!-- LÓGICA DO PAYWALL -->
        {% if page.is_premium %}
            {% if user.is_authenticated and user.userprofile.is_subscriber %}
                <!-- CONTEÚDO COMPLETO PARA ASSINANTES -->
                <div class="article-body">
                    {% if page.content_blocks %}
                        {% for block in page.content_blocks %}
                            {% if block.block_type == 'paragraph' %}
                                <div class="content-block paragraph-block">
                                    {{ block.value|richtext }}
                                </div>
                            {% elif block.block_type == 'heading' %}
                                <div class="content-block heading-block">
                                    <h2 class="content-heading">{{ block.value }}</h2>
                                </div>
                            {% elif block.block_type == 'image' %}
                                <div class="content-block image-block">
                                    {% image block.value original class="img-fluid rounded" %}
                                </div>
                            {% elif block.block_type == 'image_with_caption' %}
                                <div class="content-block image-with-caption-block">
                                    <figure class="figure w-100">
                                        {% image block.value.image original class="figure-img img-fluid rounded" %}
                                        {% if block.value.caption or block.value.credit %}
                                        <figcaption class="figure-caption">
                                            {% if block.value.caption %}{{ block.value.caption }}{% endif %}
                                            {% if block.value.credit %}<span class="text-muted"> — Foto: {{ block.value.credit }}</span>{% endif %}
                                        </figcaption>
                                        {% endif %}
                                    </figure>
                                </div>
                            {% elif block.block_type == 'video' %}
                                <div class="content-block video-block">
                                    <div class="ratio ratio-16x9">
                                        {{ block.value }}
                                    </div>
                                </div>
                            {% elif block.block_type == 'quote' %}
                                <div class="content-block quote-block">
                                    <blockquote class="blockquote-modern">
                                        <p>{{ block.value.text }}</p>
                                        {% if block.value.author %}
                                            <footer class="blockquote-footer">{{ block.value.author }}</footer>
                                        {% endif %}
                                    </blockquote>
                                </div>
                            {% elif block.block_type == 'list' %}
                                <div class="content-block list-block">
                                    <ul class="content-list">
                                        {% for item in block.value %}
                                            <li>{{ item }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            {% elif block.block_type == 'divider' %}
                                <div class="content-block divider-block">
                                    {{ block }}
                                </div>
                            {% elif block.block_type == 'html' %}
                                <div class="content-block html-block">
                                    {{ block.value|safe }}
                                </div>
                            {% endif %}
                        {% endfor %}
                    {% else %}
                        <!-- Fallback para artigos legados -->
                        {{ page.body|richtext }}
                    {% endif %}
                </div>
                
                <!-- BADGE DE ACESSO PREMIUM -->
                <div class="alert alert-light border-start border-economist-red border-4 mt-5" role="alert">
                    <small class="text-muted">
                        <i class="bi bi-check-circle-fill text-success"></i>
                        Você está lendo este conteúdo como assinante premium.
                    </small>
                </div>
            {% else %}
                <!-- PREVIEW DO CONTEÚDO (PRIMEIRAS LINHAS) -->
                <div class="article-body article-preview">
                    {% if page.content_blocks %}
                        {% for block in page.content_blocks %}
                            {% if forloop.counter <= 2 %}
                                {% if block.block_type == 'paragraph' %}
                                    <div class="content-block paragraph-block">
                                        {{ block.value|richtext|truncatewords_html:30 }}
                                    </div>
                                {% endif %}
                            {% endif %}
                        {% endfor %}
                    {% else %}
                        {{ page.body|richtext|truncatewords_html:50 }}
                    {% endif %}
                </div>
                
                <!-- PAYWALL OVERLAY -->
                <div class="paywall-overlay">
                    <div class="paywall-message">
                        <h4><i class="bi bi-lock-fill"></i> Conteúdo Exclusivo</h4>
                        <p>Esta é uma análise aprofundada disponível apenas para assinantes.</p>
                        <p class="mb-4">Junte-se a milhares de leitores que confiam em nossas análises especializadas.</p>
                        <a href="{% url 'signup' %}" class="btn btn-subscribe">
                            <i class="bi bi-star-fill"></i> Tornar-se Assinante
                        </a>
                        {% if not user.is_authenticated %}
                        <p class="mt-3 mb-0">
                            <small>Já é assinante? <a href="{% url 'login' %}" class="text-economist-red fw-bold">Faça login</a></small>
                        </p>
                        {% endif %}
                    </div>
                </div>
            {% endif %}
        {% else %}
            <!-- ARTIGO GRATUITO - CONTEÚDO COMPLETO -->
            <div class="article-body">
                {% if page.content_blocks %}
                    {% for block in page.content_blocks %}
                        {% if block.block_type == 'paragraph' %}
                            <div class="content-block paragraph-block">
                                {{ block.value|richtext }}
                            </div>
                        {% elif block.block_type == 'heading' %}
                            <div class="content-block heading-block">
                                <h2 class="content-heading">{{ block.value }}</h2>
                            </div>
                        {% elif block.block_type == 'image' %}
                            <div class="content-block image-block">
                                {% image block.value original class="img-fluid rounded" %}
                            </div>
                        {% elif block.block_type == 'image_with_caption' %}
                            <div class="content-block image-with-caption-block">
                                <figure class="figure w-100">
                                    {% image block.value.image original class="figure-img img-fluid rounded" %}
                                    {% if block.value.caption or block.value.credit %}
                                    <figcaption class="figure-caption">
                                        {% if block.value.caption %}{{ block.value.caption }}{% endif %}
                                        {% if block.value.credit %}<span class="text-muted"> — Foto: {{ block.value.credit }}</span>{% endif %}
                                    </figcaption>
                                    {% endif %}
                                </figure>
                            </div>
                        {% elif block.block_type == 'video' %}
                            <div class="content-block video-block">
                                <div class="ratio ratio-16x9">
                                    {{ block.value }}
                                </div>
                            </div>
                        {% elif block.block_type == 'quote' %}
                            <div class="content-block quote-block">
                                <blockquote class="blockquote-modern">
                                    <p>{{ block.value.text }}</p>
                                    {% if block.value.author %}
                                        <footer class="blockquote-footer">{{ block.value.author }}</footer>
                                    {% endif %}
                                </blockquote>
                            </div>
                        {% elif block.block_type == 'list' %}
                            <div class="content-block list-block">
                                <ul class="content-list">
                                    {% for item in block.value %}
                                        <li>{{ item }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        {% elif block.block_type == 'divider' %}
                            <div class="content-block divider-block">
                                {{ block }}
                            </div>
                        {% elif block.block_type == 'html' %}
                            <div class="content-block html-block">
                                {{ block.value|safe }}
                            </div>
                        {% endif %}
                    {% endfor %}
                {% else %}
                    <!-- Fallback para artigos legados -->
                    {{ page.body|richtext }}
                {% endif %}
            </div>
        {% endif %}

        <!-- BOTÃO VOLTAR -->
        <div class="mt-5 pt-4 border-top">
            <a href="{{ page.get_parent.url }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Voltar para a página inicial
            </a>
        </div>
    </article>
{% endblock %}