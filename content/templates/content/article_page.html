{% extends "base.html" %}
{% load wagtailcore_tags wagtailimages_tags %}

{% block title %}{{ page.title }}{% endblock %}

{% block content %}
    <!-- HEADER DO ARTIGO -->
    <article>
        <div class="article-header">
            <h1>
                {{ page.title }}
                {% if page.is_premium %}
                    <span class="premium-badge">Premium</span>
                {% endif %}
            </h1>
            <div class="article-meta">
                <i class="bi bi-calendar3"></i> Publicado em: {{ page.publication_date|date:"d/m/Y" }}
                <span class="mx-2">•</span>
                <i class="bi bi-clock"></i> {{ page.publication_date|timesince }} atrás
            </div>
        </div>

        <!-- IMAGEM DE DESTAQUE -->
        {% if page.featured_image %}
        <div class="mb-4">
            {% image page.featured_image original class="img-fluid rounded" %}
        </div>
        {% endif %}

        <!-- INTRODUÇÃO - SEMPRE VISÍVEL -->
        <div class="lead mb-4" style="font-size: 1.2rem; color: #333;">
            {{ page.introduction }}
        </div>

        <hr class="my-4">

        <!-- LÓGICA DO PAYWALL -->
        {% if page.is_premium %}
            {% if user.is_authenticated and user.userprofile.is_subscriber %}
                <!-- CONTEÚDO COMPLETO PARA ASSINANTES -->
                <div class="article-body">
                    {{ page.body|richtext }}
                </div>
                
                <!-- BADGE DE ACESSO PREMIUM -->
                <div class="alert alert-light border-start border-economist-red border-4 mt-5" role="alert">
                    <small class="text-muted">
                        <i class="bi bi-check-circle-fill text-success"></i>
                        Você está lendo este conteúdo como assinante premium.
                    </small>
                </div>
            {% else %}
                <!-- PREVIEW DO CONTEÚDO (PRIMEIRAS LINHAS) -->
                <div class="article-body" style="max-height: 200px; overflow: hidden; position: relative;">
                    {{ page.body|richtext|truncatewords_html:50 }}
                </div>
                
                <!-- PAYWALL OVERLAY -->
                <div class="paywall-overlay">
                    <div class="paywall-message">
                        <h4><i class="bi bi-lock-fill"></i> Conteúdo Exclusivo</h4>
                        <p>Esta é uma análise aprofundada disponível apenas para assinantes.</p>
                        <p class="mb-4">Junte-se a milhares de leitores que confiam em nossas análises especializadas.</p>
                        <a href="{% url 'signup' %}" class="btn btn-subscribe">
                            <i class="bi bi-star-fill"></i> Tornar-se Assinante
                        </a>
                        {% if not user.is_authenticated %}
                        <p class="mt-3 mb-0">
                            <small>Já é assinante? <a href="{% url 'login' %}" class="text-economist-red fw-bold">Faça login</a></small>
                        </p>
                        {% endif %}
                    </div>
                </div>
            {% endif %}
        {% else %}
            <!-- ARTIGO GRATUITO - CONTEÚDO COMPLETO -->
            <div class="article-body">
                {{ page.body|richtext }}
            </div>
        {% endif %}

        <!-- BOTÃO VOLTAR -->
        <div class="mt-5 pt-4 border-top">
            <a href="{{ page.get_parent.url }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Voltar para a página inicial
            </a>
        </div>
    </article>
{% endblock %}